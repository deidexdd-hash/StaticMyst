/**
 * РАСШИРЕННАЯ СИСТЕМА РАБОТЫ С РОДОМ
 * Глубокий анализ родовых программ на основе матрицы судьбы
 */

class AncestralEnhanced {
    constructor(knowledgeBase) {
        this.kb = knowledgeBase;
        this.userMatrix = null;
        this.birthDate = null;
        this.gender = null;
    }

    // Установка данных пользователя
    setUserData(matrix, birthDate, gender) {
        this.userMatrix = matrix;
        this.birthDate = birthDate;
        this.gender = gender;
    }

    // Главная функция: полный анализ Рода
    getFullAncestralAnalysis() {
        if (!this.userMatrix || !this.birthDate) {
            return null;
        }

        return {
            overview: this.getAncestralOverview(),
            programs: this.detectAncestralPrograms(),
            strengths: this.getAncestralStrengths(),
            challenges: this.getAncestralChallenges(),
            exclusions: this.detectExclusions(),
            tasks: this.getAncestralTasks(),
            practices: this.getRecommendedPractices(),
            tree: this.buildFamilyTreeTemplate()
        };
    }

    // Обзор родовой системы
    getAncestralOverview() {
        const birthNumber = this.getBirthNumber();
        const lifePath = this.getLifePath();
        
        const overview = {
            birthNumber: birthNumber,
            lifePath: lifePath,
            ancestralType: this.getAncestralType(birthNumber),
            energyFlow: this.analyzeEnergyFlow(),
            generalState: this.getGeneralState()
        };

        return overview;
    }

    // Определение типа Рода по числу рождения
    getAncestralType(birthNumber) {
        const types = {
            1: {
                type: 'Род Лидеров',
                description: 'В вашем Роду были сильные, властные люди - руководители, военачальники, главы семей. Род передал вам силу воли и способность управлять.',
                legacy: 'Лидерство, власть, независимость',
                challenge: 'Властолюбие, агрессивность, неумение слышать других',
                gift: 'Способность вести за собой людей и принимать ответственность'
            },
            2: {
                type: 'Род Дипломатов',
                description: 'Ваш Род состоял из миротворцев, посредников, людей, умеющих находить компромиссы. Вы несете дар договариваться.',
                legacy: 'Дипломатия, тактичность, умение сотрудничать',
                challenge: 'Неуверенность в себе, созависимость, страх одиночества',
                gift: 'Способность создавать гармоничные отношения и находить общий язык'
            },
            3: {
                type: 'Род Творцов',
                description: 'В Роду были артисты, художники, изобретатели - люди, создающие новое. Но также присутствуют исключенные души.',
                legacy: 'Творчество, креативность, нестандартное мышление',
                challenge: 'Много исключенных (аборты, убийства), растрачивание ресурсов',
                gift: 'Уникальные таланты и способность находить необычные решения'
            },
            4: {
                type: 'Род Строителей',
                description: 'Ваши предки были практичными людьми - строители, организаторы, те, кто создавал материальную основу. Род дал вам трудолюбие.',
                legacy: 'Трудолюбие, практичность, организованность',
                challenge: 'Насилие в Роду (физическое, эмоциональное), требовательность',
                gift: 'Способность создавать стабильные структуры и приносить ресурсы'
            },
            5: {
                type: 'Род Путешественников',
                description: 'В вашем Роду были свободные духи - торговцы, мореплаватели, казаки, викинги. Вы несете код свободы.',
                legacy: 'Свобода, адаптивность, любовь к переменам',
                challenge: 'Безответственность, непостоянство, игромания',
                gift: 'Способность быть свободным и позволять себе то, что запрещено другим'
            },
            6: {
                type: 'Род Хранителей Очага',
                description: 'Ваш Род ценил семью превыше всего. Предки создавали крепкие семейные узы, хранили традиции.',
                legacy: 'Семейные ценности, гармония, красота',
                challenge: 'Зависимость только от семьи, требовательность, страхи',
                gift: 'Способность создавать красоту и гармонию вокруг себя'
            },
            7: {
                type: 'Род Мудрецов',
                description: 'В Роду были духовные учителя, целители, мистики - проводники знаний. Вы несете духовную миссию.',
                legacy: 'Духовность, мудрость, работа с энергиями',
                challenge: 'Отстраненность, высокомерие, потребность в признании',
                gift: 'Способность работать с тонкими энергиями и вести людей духовно'
            },
            8: {
                type: 'Род Магнатов',
                description: 'Ваши предки умели зарабатывать деньги, создавать богатство. Род передал вам финансовый потенциал.',
                legacy: 'Деньги, материальное благополучие, влияние',
                challenge: 'Потеря денег, потеря репутации, страх бедности',
                gift: 'Способность материализовать идеи и создавать богатство'
            },
            9: {
                type: 'Род Воинов',
                description: 'В Роду были воины, защитники, те, кто расширял границы. Вы несете силу экспансии.',
                legacy: 'Сила, решительность, способность побеждать',
                challenge: 'Отказ от Рода, агрессия, стремление контролировать',
                gift: 'Способность отвоевывать новое и приносить это в Род'
            }
        };

        return types[birthNumber] || types[1];
    }

    // Выявление родовых программ
    detectAncestralPrograms() {
        const programs = [];
        const birthNumber = this.getBirthNumber();
        const counts = this.userMatrix.matrix_counts || {};

        // Программы по числу рождения
        const birthPrograms = this.getBirthNumberPrograms(birthNumber);
        programs.push(...birthPrograms);

        // Программы по пустым ячейкам (исключенные качества)
        for (let i = 1; i <= 9; i++) {
            if ((counts[i] || 0) === 0) {
                programs.push({
                    type: 'exclusion',
                    severity: 'high',
                    number: i,
                    title: `Исключенное качество ${i}`,
                    description: this.getExclusionDescription(i),
                    origin: `В Роду было отвержение ${this.getQualityName(i).toLowerCase()}`,
                    impact: this.getExclusionImpact(i),
                    healing: this.getExclusionHealing(i)
                });
            }
        }

        // Программы по избыточным числам
        for (let i = 1; i <= 9; i++) {
            if ((counts[i] || 0) > 5) {
                programs.push({
                    type: 'excess',
                    severity: 'medium',
                    number: i,
                    count: counts[i],
                    title: `Избыток ${this.getQualityName(i)}`,
                    description: `Слишком много энергии ${i} - необходима балансировка`,
                    origin: `Род передал избыточную энергию ${this.getQualityName(i).toLowerCase()}`,
                    impact: this.getExcessImpact(i),
                    healing: this.getExcessHealing(i)
                });
            }
        }

        // Кармические долги
        const karmicDebts = this.detectKarmicDebts();
        programs.push(...karmicDebts);

        // Родовые проклятия (по специфическим паттернам)
        const curses = this.detectCurses();
        programs.push(...curses);

        return programs;
    }

    // Программы по числу рождения
    getBirthNumberPrograms(number) {
        const programsMap = {
            1: [
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа властолюбия',
                    description: 'В Роду была борьба за власть, подавление других',
                    origin: 'Предки стремились к власти любой ценой',
                    signs: ['Желание контролировать', 'Упрямство', 'Неумение слышать других'],
                    impact: 'Проблемы в отношениях, конфликты, одиночество',
                    healing: 'Научиться управлять без агрессии, развивать эмпатию'
                },
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа ухода от Рода',
                    description: 'Тенденция отвергать родовую систему и идти своим путем',
                    origin: 'Конфликты в Роду, разрывы связей',
                    signs: ['Желание уехать далеко', 'Отрицание родовых ценностей', 'Одиночество'],
                    impact: 'Отсутствие поддержки Рода, необходимость все создавать самому',
                    healing: 'Принять Род, взять суперсилу, исполнить предназначение'
                }
            ],
            2: [
                {
                    type: 'ancestral',
                    severity: 'medium',
                    title: 'Программа отказа от себя',
                    description: 'В Роду жертвовали собой ради других',
                    origin: 'Предки не ставили себя на первое место',
                    signs: ['Неуверенность в себе', 'Жертвенность', 'Страх быть эгоистом'],
                    impact: 'Низкая самооценка, созависимые отношения',
                    healing: 'Научиться ставить себя на первое место, развивать уверенность'
                }
            ],
            3: [
                {
                    type: 'ancestral',
                    severity: 'critical',
                    title: 'Программа исключенных',
                    description: 'В Роду много абортов, убийств, исключенных душ',
                    origin: 'Аборты, убийства, отвергнутые члены семьи',
                    signs: ['Нет опоры', 'Растрачивание ресурсов', 'Поиск к кому примкнуть'],
                    impact: 'Отсутствие внутренней опоры, нестабильность жизни',
                    healing: 'Практика принятия исключенных, работа с генограммой'
                },
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа жадности',
                    description: 'Родовая жадность и страх потерять ресурсы',
                    origin: 'Предки переживали голод, нищету',
                    signs: ['Жадность', 'Ревность', 'Страх делиться'],
                    impact: 'Блокировка денежного потока, проблемы с изобилием',
                    healing: 'Практики щедрости, работа со страхом нехватки'
                }
            ],
            4: [
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа насилия',
                    description: 'В Роду было физическое и эмоциональное насилие',
                    origin: 'Предки применяли силу для достижения целей',
                    signs: ['Требовательность', 'Эмоциональное давление', 'Жесткость'],
                    impact: 'Проблемы в отношениях, отторжение близких',
                    healing: 'Научиться мягкости, принятию, отказаться от насилия'
                }
            ],
            5: [
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа безответственности',
                    description: 'Род передал легкомысленное отношение к обязательствам',
                    origin: 'Свободные люди, не связывающие себя',
                    signs: ['Непостоянство', 'Побеги от ответственности', 'Игромания'],
                    impact: 'Нестабильность, проблемы с деньгами и отношениями',
                    healing: 'Научиться ответственности, доводить дела до конца'
                },
                {
                    type: 'ancestral',
                    severity: 'medium',
                    title: 'Денежная блокировка',
                    description: 'Программа потери денег через риск',
                    origin: 'Предки теряли деньги в азартных играх, рискованных предприятиях',
                    signs: ['Финансовая нестабильность', 'Тяга к риску', 'Потери'],
                    impact: 'Невозможность накопить, постоянные финансовые качели',
                    healing: 'Практики изобилия, работа со страхом стабильности'
                }
            ],
            6: [
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа отказа от предназначения',
                    description: 'Род выбирал семью вместо своего пути',
                    origin: 'Предки жертвовали своими целями ради семьи',
                    signs: ['Страх выбрать себя', 'Вина перед семьей', 'Жертвенность'],
                    impact: 'Нереализованность, внутренний конфликт',
                    healing: 'Совместить семью и предназначение, научиться опираться на весь Род'
                }
            ],
            7: [
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа отказа от предназначения',
                    description: 'Род не реализовал духовную миссию',
                    origin: 'Предки скрывали свои способности, не служили',
                    signs: ['Страх проявиться', 'Высокомерие как защита', 'Отстраненность'],
                    impact: 'Нереализованность, внутренняя пустота',
                    healing: 'Принять свою миссию, начать служение'
                }
            ],
            8: [
                {
                    type: 'ancestral',
                    severity: 'critical',
                    title: 'Программа потери денег',
                    description: 'Род терял богатство через поколения',
                    origin: 'Революции, войны, конфискации, обманы',
                    signs: ['Страх потерять деньги', 'Скрягость', 'Недоверие'],
                    impact: 'Блокировка денежного потока, бедность',
                    healing: 'Найти предназначение и начать зарабатывать честно'
                },
                {
                    type: 'ancestral',
                    severity: 'high',
                    title: 'Программа потери репутации',
                    description: 'Предки теряли честь и доброе имя',
                    origin: 'Скандалы, преступления, позор в Роду',
                    signs: ['Страх осуждения', 'Перфекционизм', 'Контроль имиджа'],
                    impact: 'Зависимость от мнения других, внутреннее напряжение',
                    healing: 'Восстановить честь через служение и честность'
                }
            ],
            9: [
                {
                    type: 'ancestral',
                    severity: 'critical',
                    title: 'Программа отказа от Рода',
                    description: 'Сильная программа разрыва с родовой системой',
                    origin: 'Предки уходили из Рода, создавали новые линии',
                    signs: ['Желание порвать с семьей', 'Создание нового', 'Одиночество'],
                    impact: 'Необходимость все создавать с нуля без поддержки',
                    healing: 'Принести в Род то, чего не было - новую профессию, знания'
                }
            ]
        };

        return programsMap[number] || [];
    }

    // Описание исключенных качеств
    getExclusionDescription(number) {
        const descriptions = {
            1: 'В Роду подавлялось лидерство, инициативность. Возможно, предков наказывали за самостоятельность.',
            2: 'Отвергалась мягкость, дипломатия. Возможно, в Роду не ценили чувствительность.',
            3: 'Подавлялось творчество, радость жизни. Возможно, артистов и мечтателей считали неудачниками.',
            4: 'Отвергался труд, дисциплина. Возможно, трудолюбивых эксплуатировали.',
            5: 'Подавлялась свобода, предки были в рабстве или крепостничестве.',
            6: 'Отвергалась любовь, гармония. Возможно, в Роду были холодные отношения.',
            7: 'Подавлялась духовность. Возможно, преследовались за веру или мистические способности.',
            8: 'Отвергалось богатство. Возможно, осуждали за деньги или отбирали их.',
            9: 'Подавлялось служение. Возможно, тех, кто помогал другим, считали слабыми.'
        };
        return descriptions[number] || '';
    }

    getExclusionImpact(number) {
        return `У вас отсутствует энергия ${this.getQualityName(number).toLowerCase()}, что создает дисбаланс в жизни.`;
    }

    getExclusionHealing(number) {
        return `Необходимо сознательно развивать ${this.getQualityName(number).toLowerCase()} через практики и действия.`;
    }

    // Описание избытка
    getExcessImpact(number) {
        return `Слишком много энергии ${this.getQualityName(number).toLowerCase()} приводит к перекосу и проблемам.`;
    }

    getExcessHealing(number) {
        return `Необходимо балансировать энергию ${this.getQualityName(number).toLowerCase()}, направлять ее конструктивно.`;
    }

    // Выявление кармических долгов
    detectKarmicDebts() {
        const debts = [];
        const parts = this.birthDate.split('.');
        const year = parseInt(parts[2]);
        const month = parseInt(parts[1]);
        const day = parseInt(parts[0]);
        
        // Проверка на кармические числа 13, 14, 16, 19
        const yearSum = this.sumDigits(year);
        const monthDaySum = day + month;
        
        const karmicNumbers = [13, 14, 16, 19];
        
        if (karmicNumbers.includes(yearSum)) {
            debts.push(this.getKarmicDebtDescription(yearSum));
        }
        
        if (karmicNumbers.includes(monthDaySum)) {
            debts.push(this.getKarmicDebtDescription(monthDaySum));
        }

        return debts;
    }

    getKarmicDebtDescription(number) {
        const descriptions = {
            13: {
                type: 'karmic',
                severity: 'critical',
                number: 13,
                title: 'Кармический долг 13 - Лень',
                description: 'В прошлых воплощениях избегали труда, перекладывали работу на других',
                origin: 'Прошлая жизнь с ленью и паразитизмом',
                signs: ['Прокрастинация', 'Избегание усилий', 'Желание легкого пути'],
                impact: 'Все дается через усилия, легких путей нет',
                healing: 'Практика трудолюбия 40 дней, завершение всех начатых дел'
            },
            14: {
                type: 'karmic',
                severity: 'critical',
                number: 14,
                title: 'Кармический долг 14 - Злоупотребление свободой',
                description: 'В прошлых жизнях злоупотребляли свободой, предавались излишествам',
                origin: 'Прошлая жизнь в разврате, наркомании, алкоголизме',
                signs: ['Зависимости', 'Неумеренность', 'Импульсивность'],
                impact: 'Склонность к зависимостям, нужен постоянный контроль',
                healing: 'Практика умеренности 40 дней, отказ от вредных привычек'
            },
            16: {
                type: 'karmic',
                severity: 'critical',
                number: 16,
                title: 'Кармический долг 16 - Гордыня',
                description: 'В прошлых жизнях проявляли гордыню, высокомерие, эгоизм',
                origin: 'Прошлая жизнь в эго, презрении к другим',
                signs: ['Падения с высот', 'Разрушение достигнутого', 'Одиночество'],
                impact: 'Цикличные потери всего, что построено на гордыне',
                healing: 'Практика смирения 40 дней, служение без гордости'
            },
            19: {
                type: 'karmic',
                severity: 'critical',
                number: 19,
                title: 'Кармический долг 19 - Злоупотребление властью',
                description: 'В прошлых жизнях использовали власть для угнетения, были тиранами',
                origin: 'Прошлая жизнь с властью, которой злоупотребляли',
                signs: ['Потеря власти', 'Блокировка лидерства', 'Проблемы с деньгами'],
                impact: 'Сложно получить власть и деньги, постоянные препятствия',
                healing: 'Практика служения 40 дней, использование силы для помощи'
            }
        };

        return descriptions[number] || null;
    }

    // Выявление родовых проклятий
    detectCurses() {
        const curses = [];
        const counts = this.userMatrix.matrix_counts || {};
        
        // Проклятие бедности (нет 8)
        if ((counts[8] || 0) === 0) {
            curses.push({
                type: 'curse',
                severity: 'high',
                title: 'Родовое проклятие бедности',
                description: 'Отсутствие энергии денег в матрице указывает на родовую программу бедности',
                origin: 'Проклятие может быть наложено на предков или самоналожено',
                signs: ['Хроническая нехватка денег', 'Невозможность накопить', 'Потери'],
                impact: 'Блокировка денежного потока на уровне Рода',
                healing: 'Практика снятия проклятия, работа с генограммой'
            });
        }

        // Проклятие одиночества (нет 2 и 6)
        if ((counts[2] || 0) === 0 && (counts[6] || 0) === 0) {
            curses.push({
                type: 'curse',
                severity: 'high',
                title: 'Родовое проклятие одиночества',
                description: 'Отсутствие энергий отношений указывает на проблемы с любовью в Роду',
                origin: 'Предки могли быть прокляты на одиночество',
                signs: ['Невозможность создать пару', 'Разрушение отношений', 'Одиночество'],
                impact: 'Блокировка личной жизни',
                healing: 'Практика снятия проклятия, работа с родом женской/мужской линии'
            });
        }

        return curses;
    }

    // Родовые силы (суперсилы)
    getAncestralStrengths() {
        const strengths = [];
        const birthNumber = this.getBirthNumber();
        const counts = this.userMatrix.matrix_counts || {};

        // Суперсила по числу рождения
        strengths.push(this.getBirthNumberStrength(birthNumber));

        // Суперсилы по заполненным числам
        for (let i = 1; i <= 9; i++) {
            if ((counts[i] || 0) >= 3) {
                strengths.push({
                    number: i,
                    title: `Сила ${this.getQualityName(i)}`,
                    description: this.getStrengthDescription(i),
                    howToUse: this.getStrengthUsage(i)
                });
            }
        }

        return strengths;
    }

    getBirthNumberStrength(number) {
        const strengths = {
            1: {
                number: 1,
                title: 'Суперсила Лидерства',
                description: 'Род дал вам способность вести людей за собой, принимать решения, брать ответственность',
                howToUse: 'Станьте руководителем, создайте бизнес, ведите команду к цели'
            },
            2: {
                number: 2,
                title: 'Суперсила Дипломатии',
                description: 'Род передал умение договариваться, находить компромиссы, создавать гармонию',
                howToUse: 'Станьте переговорщиком, медиатором, создавайте партнерства'
            },
            3: {
                number: 3,
                title: 'Суперсила Творчества',
                description: 'Род наделил способностью создавать новое, находить нестандартные решения',
                howToUse: 'Реализуйте творческие проекты, изобретайте, создавайте искусство'
            },
            4: {
                number: 4,
                title: 'Суперсила Созидания',
                description: 'Род дал умение структурировать, организовывать, создавать стабильность',
                howToUse: 'Создавайте системы, организуйте процессы, стройте фундаменты'
            },
            5: {
                number: 5,
                title: 'Суперсила Свободы',
                description: 'Род передал способность быть свободным, адаптироваться, рисковать',
                howToUse: 'Будьте независимым предпринимателем, путешествуйте, создавайте новое'
            },
            6: {
                number: 6,
                title: 'Суперсила Любви',
                description: 'Род наделил способностью любить, создавать красоту и гармонию',
                howToUse: 'Создавайте крепкие семьи, облагораживайте пространство, несите любовь'
            },
            7: {
                number: 7,
                title: 'Суперсила Духовности',
                description: 'Род дал способность работать с энергиями, познавать тайное',
                howToUse: 'Станьте духовным учителем, целителем, проводником знаний'
            },
            8: {
                number: 8,
                title: 'Суперсила Изобилия',
                description: 'Род передал умение создавать богатство, материализовать идеи',
                howToUse: 'Стройте бизнес-империю, зарабатывайте большие деньги честно'
            },
            9: {
                number: 9,
                title: 'Суперсила Служения',
                description: 'Род наделил способностью служить высшему благу, помогать людям',
                howToUse: 'Станьте целителем, учителем, тем, кто ведет людей к свету'
            }
        };

        return strengths[number] || strengths[1];
    }

    getStrengthDescription(number) {
        return `У вас сильная энергия ${this.getQualityName(number).toLowerCase()} - это дар Рода`;
    }

    getStrengthUsage(number) {
        return `Используйте силу ${this.getQualityName(number).toLowerCase()} в своей профессии и жизни`;
    }

    // Родовые задачи
    getAncestralTasks() {
        const tasks = [];
        const birthNumber = this.getBirthNumber();

        // Главная родовая задача по числу рождения
        tasks.push(this.getMainAncestralTask(birthNumber));

        // Задачи по программам
        const programs = this.detectAncestralPrograms();
        programs.forEach(program => {
            if (program.severity === 'critical' || program.severity === 'high') {
                tasks.push({
                    title: `Отработать ${program.title}`,
                    description: program.healing,
                    priority: program.severity
                });
            }
        });

        return tasks;
    }

    getMainAncestralTask(number) {
        const tasks = {
            1: {
                title: 'Реализовать предназначение лидера',
                description: 'Главная задача Рода - чтобы вы стали настоящим лидером, управляющим с мудростью, а не агрессией',
                steps: [
                    'Найдите область, где можете вести людей',
                    'Развивайте эмпатию и умение слышать',
                    'Берите ответственность за результат',
                    'Управляйте с любовью, а не страхом'
                ]
            },
            2: {
                title: 'Обрести уверенность в себе',
                description: 'Главная задача - преодолеть родовую неуверенность и стать решительным',
                steps: [
                    'Принимайте решения самостоятельно',
                    'Развивайте веру в себя',
                    'Учитесь говорить "нет"',
                    'Ставьте себя на первое место'
                ]
            },
            3: {
                title: 'Принять исключенных Рода',
                description: 'Главная задача - вернуть в Род всех исключенных и обрести целостность',
                steps: [
                    'Выполните практику принятия исключенных',
                    'Работайте с генограммой',
                    'Найдите баланс я-семья-социум',
                    'Используйте креативность конструктивно'
                ]
            },
            4: {
                title: 'Стать проводником знаний',
                description: 'Главная задача - передавать уникальные знания Рода миру',
                steps: [
                    'Структурируйте знания Рода',
                    'Создайте систему обучения',
                    'Делитесь знаниями без насилия',
                    'Приносите большие ресурсы'
                ]
            },
            5: {
                title: 'Совместить свободу и ответственность',
                description: 'Главная задача - оставаться свободным, но выполнять обязательства',
                steps: [
                    'Найдите дело, которому преданы',
                    'Развивайте ответственность',
                    'Доводите начатое до конца',
                    'Используйте свободу конструктивно'
                ]
            },
            6: {
                title: 'Опереться на весь Род',
                description: 'Главная задача - расширить опору с семьи на всю родовую систему',
                steps: [
                    'Познайте историю всего Рода',
                    'Доверяйте не только семье',
                    'Научитесь получать от всех предков',
                    'Совместите семью и предназначение'
                ]
            },
            7: {
                title: 'Реализовать духовную миссию',
                description: 'Главная задача - стать проводником духовности для других',
                steps: [
                    'Примите свою миссию',
                    'Развивайте духовные способности',
                    'Учите других без высокомерия',
                    'Служите высшему благу'
                ]
            },
            8: {
                title: 'Найти предназначение и заработать',
                description: 'Главная задача - реализоваться и начать зарабатывать большие деньги',
                steps: [
                    'Найдите свой путь',
                    'Реализуйте предназначение',
                    'Зарабатывайте честно',
                    'Оставьте наследие после себя'
                ]
            },
            9: {
                title: 'Принести новое в Род',
                description: 'Главная задача - не быть как все в Роду, создать новое направление',
                steps: [
                    'Выберите профессию, которой не было в Роду',
                    'Получите новые знания',
                    'Совершите экспансию в новые области',
                    'Принесите это обратно в Род'
                ]
            }
        };

        return tasks[number] || tasks[1];
    }

    // Выявление исключенных
    detectExclusions() {
        return {
            description: 'Исключенные - это члены Рода, которые были отвергнуты, забыты или вычеркнуты из системы',
            types: [
                'Аборты и выкидыши',
                'Мертворожденные дети',
                'Убитые или убившие себя',
                'Отвергнутые члены семьи',
                'Те, о ком не говорят',
                'Первые партнеры родителей',
                'Дети от первых браков'
            ],
            impact: 'Исключенные создают дисбаланс в системе. Их энергия тянет живых вниз, создавая проблемы',
            signs: [
                'Повторяющиеся паттерны потерь',
                'Беспричинное чувство вины',
                'Тяга к саморазрушению',
                'Отсутствие опоры в жизни',
                'Финансовые проблемы'
            ],
            healing: {
                title: 'Практика принятия исключенных',
                duration: '2 дня',
                description: 'Ритуал возвращения исключенных в родовую систему',
                steps: [
                    'День 1: Зажгите свечу за каждого исключенного',
                    'Скажите: "[Имя/описание], я вижу тебя"',
                    'Продолжите: "Ты принадлежишь этому Роду"',
                    'Почувствуйте принятие',
                    'День 2: Повторите ритуал',
                    'Скажите: "Теперь ты на своем месте в Роду"',
                    'Ощутите целостность системы'
                ]
            }
        };
    }

    // Рекомендованные практики
    getRecommendedPractices() {
        return {
            essential: [
                {
                    name: 'Работа с генограммой',
                    priority: 'critical',
                    duration: '9 дней',
                    description: 'Основная практика для работы с Родом',
                    when: 'Начать как можно скорее'
                },
                {
                    name: 'Практика принятия исключенных',
                    priority: 'high',
                    duration: '2 дня',
                    description: 'Возвращение отвергнутых в систему',
                    when: 'После генограммы'
                }
            ],
            supportive: [
                {
                    name: 'Медитация связи с предками',
                    priority: 'medium',
                    duration: '30 минут',
                    frequency: '1 раз в неделю',
                    description: 'Укрепление связи с Родом'
                },
                {
                    name: 'Практика снятия проклятия',
                    priority: 'high',
                    duration: '24 дня',
                    description: 'Если обнаружено проклятие',
                    when: 'По необходимости'
                }
            ]
        };
    }

    // Родовые трудности
    getAncestralChallenges() {
        const challenges = [];
        const programs = this.detectAncestralPrograms();
        
        programs.forEach(program => {
            if (program.severity === 'critical' || program.severity === 'high') {
                challenges.push({
                    title: program.title,
                    description: program.description,
                    impact: program.impact,
                    solution: program.healing
                });
            }
        });

        return challenges;
    }

    // Шаблон семейного древа
    buildFamilyTreeTemplate() {
        return {
            description: 'Генограмма - графическое изображение вашей родовой системы',
            howToBuild: [
                'Нарисуйте себя внизу (квадрат - мужчина, круг - женщина)',
                'Над собой нарисуйте родителей',
                'Соедините их горизонтальной линией (брак)',
                'От линии брака вниз - линия к вам',
                'Нарисуйте бабушек и дедушек',
                'Добавьте братьев, сестер родителей',
                'Отметьте всех известных предков',
                'Укажите даты рождения и смерти',
                'Отметьте особыми символами: аборты (х), разводы (//), конфликты'
            ],
            symbols: {
                male: '□ - Мужчина',
                female: '○ - Женщина',
                marriage: '═ - Брак',
                divorce: '//═ - Развод',
                death: '□/○ с X - Умерший',
                abortion: 'x - Аборт/выкидыш',
                conflict: '⚡ - Конфликт'
            },
            usage: 'Используйте генограмму для практики работы с Родом'
        };
    }

    // Анализ потока энергии в Роду
    analyzeEnergyFlow() {
        const counts = this.userMatrix.matrix_counts || {};
        const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
        const average = total / 9;

        if (average < 1.5) {
            return {
                state: 'Слабый поток',
                description: 'Энергия Рода течет слабо, много блокировок',
                recommendation: 'Необходимо активно работать с Родом, открывать каналы'
            };
        } else if (average < 2.5) {
            return {
                state: 'Умеренный поток',
                description: 'Энергия течет, но есть препятствия',
                recommendation: 'Продолжайте практики, убирайте блоки'
            };
        } else {
            return {
                state: 'Сильный поток',
                description: 'Энергия Рода течет хорошо, есть поддержка',
                recommendation: 'Используйте силу Рода для реализации целей'
            };
        }
    }

    // Общее состояние родовой системы
    getGeneralState() {
        const programs = this.detectAncestralPrograms();
        const critical = programs.filter(p => p.severity === 'critical').length;
        const high = programs.filter(p => p.severity === 'high').length;

        if (critical > 2 || high > 4) {
            return {
                level: 'Требует серьезной работы',
                description: 'В родовой системе много тяжелых программ',
                urgency: 'high',
                recommendation: 'Начните работу с Родом немедленно, используйте все доступные практики'
            };
        } else if (critical > 0 || high > 2) {
            return {
                level: 'Требует внимания',
                description: 'Есть родовые программы, которые нужно проработать',
                urgency: 'medium',
                recommendation: 'Регулярно выполняйте практики работы с Родом'
            };
        } else {
            return {
                level: 'Относительно гармоничное',
                description: 'Родовая система в неплохом состоянии',
                urgency: 'low',
                recommendation: 'Поддерживайте связь с Родом, берите силу предков'
            };
        }
    }

    // Вспомогательные функции
    getBirthNumber() {
        const day = parseInt(this.birthDate.split('.')[0]);
        return day <= 9 ? day : this.sumDigits(day);
    }

    getLifePath() {
        const parts = this.birthDate.split('.');
        const sum = parseInt(parts[0]) + parseInt(parts[1]) + parseInt(parts[2]);
        return this.sumDigits(sum);
    }

    sumDigits(num) {
        let sum = 0;
        const str = Math.abs(num).toString();
        for (let digit of str) {
            sum += parseInt(digit);
        }
        return sum > 9 ? this.sumDigits(sum) : sum;
    }

    getQualityName(number) {
        const qualities = {
            1: 'Лидерство и сила воли',
            2: 'Дипломатия и партнерство',
            3: 'Творчество и самовыражение',
            4: 'Стабильность и структура',
            5: 'Свобода и адаптивность',
            6: 'Гармония и любовь',
            7: 'Мудрость и духовность',
            8: 'Изобилие и власть',
            9: 'Служение и завершение'
        };
        return qualities[number] || 'Неизвестное качество';
    }
}

// Экспорт
if (typeof module !== 'undefined' && module.exports) {
    module.exports = AncestralEnhanced;
}
